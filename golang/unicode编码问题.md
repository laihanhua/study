## ç”±emojiå¼•å‘çš„ç¼–ç é—®é¢˜

ç« é±¼å“¥ç³»ç»Ÿæ¥å£éœ€è¦è¿”å›ç©å®¶ä¸­æ–‡åå­—çš„unicodeç ï¼Œç”±äºæœ‰äº›ç©å®¶è¿‡äºè°ƒçš®ï¼Œåå­—ä¸­å¸¦æœ‰ğŸ’€emojiå­—ç¬¦ï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬è‡ªå®šä¹‰åçš„json.Marshalç¼–ç é”™è¯¯ï¼Œä¸‹é¢å°±æ¥æ¢è®¨ä¸€ä¸‹Unicodeçš„ä¸€äº›ç¼–ç é—®é¢˜ä»¥åŠgolangå†…çš„å¤„ç†ã€‚

## æ¢ç©¶unicodeã€utf-8ã€utf-16

### ç®€è¦ä»‹ç»
å¤§å®¶å¯èƒ½å·²ç»å¯¹è¿™ä¸‰ç§ç¼–ç æ–¹å¼æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œæˆ‘å°±ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š

Unicodeåªæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ç¬¦å·é›†ï¼Œè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå¹¶æ²¡æœ‰è§„å®šå¦‚ä½•å»å­˜å‚¨ï¼›Unicodeçš„ç¼–ç ç©ºé—´ä»U+0000åˆ°U+10FFFFã€‚ä»U+xx0000åˆ°U+xxFFFFå…¶ä¸­å¯ä»¥åŒ…å«17ä¸ªå¹³é¢ç ä½ï¼ˆxxå¯ä»¥è¡¨ç¤º00-FFï¼‰ï¼Œæ­£å¸¸æ¥è¯´æˆ‘ä»¬ä½¿ç”¨åŸºæœ¬å¹³é¢ï¼ˆåŸºç¡€å­—æ®µï¼‰å°±å¤Ÿäº†ï¼Œå³U+0000åˆ°U+FFFFã€‚å…¶ä½™çš„ä¸ºè¾…åŠ©æ‰©å±•å­—æ®µã€‚

UTF-8æ˜¯Unicodeçš„ä¸€ç§å®ç°ï¼Œgolangå†…çš„ç¼–ç ä¹Ÿæ˜¯UTF-8ç¼–ç ã€‚å®ƒæ˜¯ä¸€ç§å˜å­—èŠ‚çš„ç¼–ç æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨1ï½4ä¸ªå­—èŠ‚ä»£ç ä¸€ä¸ªç¬¦å·ï¼Œä¸€èˆ¬æ¥è¯´å­—æ¯ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºäº†ï¼Œæ™®é€šçš„ä¸­æ–‡ä¹Ÿä¸ä¼šè¶…è¿‡3ä¸ªå­—èŠ‚ã€‚ä¸è¿‡
ğŸ’€å­—ç¬¦å°±ä½¿ç”¨äº†4ä¸ªå­—èŠ‚ã€‚ï¼ˆå’¦ï½ä¸Šé¢ä¸æ˜¯è¯´UnicodeåŸºæœ¬å­—æ®µU+0000åˆ°U+FFFFï¼Œåº”è¯¥æ˜¯2ä¸ªå­—èŠ‚å‘€ï¼Ÿè«æ€¥ï¼Œåé¢æœ‰è§£é‡Šï¼‰

UTF-16ä¹Ÿæ˜¯Unicodeçš„ç¼–ç å®ç°ï¼Œå®ƒè§„å®šä½¿ç”¨2ä¸ªå­—èŠ‚æˆ–4ä¸ªå­—èŠ‚æ¥ï¼›å…¶å®åœ¨2ä¸ªå­—èŠ‚çš„æƒ…å†µï¼ŒUTF-16ç¼–ç çš„16è¿›åˆ¶æ•°å°±æ˜¯å¯¹åº”unicodeç ç‚¹ï¼›è€Œåœ¨4å­—èŠ‚çš„æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨ä»£ç†å¯¹(surrogate pair)æ¥è¡¨ç¤ºä¸€ä¸ªUnicodeç ç‚¹ï¼›

### ç¼–ç å®ç°
å…¶å®UTFæ˜¯â€œUnicode Transformation Formatâ€çš„ç¼©å†™ï¼Œåˆšåˆšè¯´äº†ï¼ŒUnicodeç ç‚¹æ˜¯å…¨çƒç»Ÿä¸€çš„ï¼Œé‚£ä¹ˆå…·ä½“UTF-8/UTF-16æ˜¯å¦‚ä½•ç¼–ç çš„å‘¢ï¼Ÿæ‹¿ğŸ’€å­—ç¬¦ä¸ºä¾‹è¯´æ˜ï¼Œå…¶ä¸­è¯¥å­—ç¬¦çš„Unicodeç ç‚¹ä¸ºU+1F480ï¼Œå‚è€ƒæˆ³[è¿™é‡Œ](https://apps.timwhitlock.info/unicode/inspect/hex/1F480#block-U1F300)

#### UTF-8
æˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ªè¡¨æ ¼æ¥çœ‹ä¸‹å°†Unicodeå­—ç¬¦è½¬æ¢ä¸ºUTF-8ç¼–ç æ–¹å¼çš„å…·ä½“æ­¥éª¤:

|Unicodeç ç‚¹èŒƒå›´|UTF-8ç¼–ç æ–¹å¼
|---|---|
|U+0000~U+007F|0xxxxxx
|U+0080~U+07FF|110xxxxx 10xxxxxx
|U+0800~U+FFFF|1110xxxx 10xxxxxx 10xxxxxx
|U+10000~U+10FFFF|11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
ä»è¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç”±äºUTF-8çš„ç¼–ç å®ç°æ–¹å¼ï¼Œæ‰€ä»¥0800~FFFFçœ‹ä¼¼ä¸¤ä¸ªå­—èŠ‚ï¼Œå®é™…å­˜å‚¨æ—¶ä½¿ç”¨çš„æ˜¯ä¸‰ä¸ªå­—èŠ‚ã€‚é‚£ä¹ˆå­—ç¬¦ğŸ’€çš„ç ç‚¹ä¸ºU+1F480ï¼Œåˆ™ä½¿ç”¨å››ä¸ªå­—èŠ‚å­˜å‚¨ã€‚

1F480çš„äºŒè¿›åˆ¶ä¸º11111 010010 000000ï¼Œæ ¹æ®è¡¨æ ¼ä¸­ä»å·¦å¾€å³çš„å¡«å……è§„åˆ™ï¼Œé‚£ä¹ˆå¾—åˆ°çš„UTF-8ç¼–ç ä¸º

```
1111 0000 =F0
1001 1111 =9F
1001 0010 =92
1000 0000 =80
```

#### UTF-16
åŒæ ·æˆ‘ä»¬ä¹Ÿé€šè¿‡è¡¨æ ¼æ¥çœ‹ä¸‹ç¼–ç æ–¹å¼

|Unicodeç ç‚¹èŒƒå›´|UTF-16ç¼–ç æ–¹å¼
|---|---|
|U+0000~U+FFFF|2 Byteå­˜å‚¨ï¼Œç¼–ç åç­‰äºUnicodeå€¼
|U+10000~U+10FFFF|4 Byteå­˜å‚¨ï¼Œç°å°†Unicodeå€¼å‡å»ï¼ˆ0x10000ï¼‰ï¼Œå¾—åˆ°20bité•¿çš„å€¼ã€‚å†å°†Unicodeåˆ†ä¸ºé«˜10ä½å’Œä½10ä½ã€‚UTF-16ç¼–ç çš„é«˜ä½æ˜¯2 Byteï¼Œé«˜10ä½UnicodeèŒƒå›´ä¸º0-0x3FFï¼Œå°†Unicodeå€¼åŠ ä¸Š0XD800ï¼Œå¾—åˆ°é«˜ä½ä»£ç†ï¼ˆæˆ–ç§°ä¸ºå‰å¯¼ä»£ç†ï¼Œå­˜å‚¨é«˜ä½ï¼‰ï¼›ä½ä½ä¹Ÿæ˜¯2 Byteï¼Œä½åä½UnicodeèŒƒå›´ä¸€æ ·ä¸º0~0x3FFï¼Œå°†Unicodeå€¼åŠ ä¸Š0xDC00,å¾—åˆ°ä½ä½ä»£ç†ï¼ˆæˆ–ç§°ä¸ºåå°¾ä»£ç†ï¼Œå­˜å‚¨ä½ä½ï¼‰

å¯¹äºä¸¤ä¸ªå­—èŠ‚çš„æƒ…å†µå°±æ¯”è¾ƒç®€å•ç²—æš´ï¼Œå­˜å‚¨å€¼å°±æ˜¯å¯¹åº”çš„ç ç‚¹ï¼›è¿˜æœ‰å¤§å¤´ï¼ˆFE FFï¼‰/å°å¤´(FF FE)æ–¹å¼å­˜å‚¨ï¼Œå­˜å‚¨çš„é¡ºåºä¹Ÿä¸ä¸€æ ·ï¼Œä¸è¿‡ç¼–ç è§„åˆ™æ˜¯ä¸€æ ·çš„ã€‚

å› ä¸º1F480>FFFFï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨4å­—èŠ‚å­˜å‚¨ã€‚

```
1. å°†Unicodeå€¼å‡å»0x1F480-0x10000å¾—åˆ°0x0F480=0000 1111 0100 1000 0000
2. é«˜10ä½å’Œä½10ä½
	0000111101=0x003D
	0010000000=0x0080
3. é«˜10ä½Unicodeå€¼åŠ ä¸Š0xD800å¾—åˆ°é«˜ä½ä»£ç†ï¼š0xD83D
4. ä½10ä½Unicodeå€¼åŠ ä¸Š0xDC00å¾—åˆ°ä½ä½ä»£ç†ï¼š0xDC80
```
å¾—åˆ°UTF-16çš„ä»£ç†å¯¹ä½0xD830/0xDC80ï¼Œæ ¹æ®å°å¤´æ–¹å¼æ’åˆ—çš„UTF-16 LEç¼–ç ä¸º3D D8 80 DC

#### golangéªŒè¯

```
package main

import (
    "fmt"
    "strconv"
    "unicode/utf16"
)

func main() {
    str := "ğŸ’€"
    fmt.Println("Unicodeç ç‚¹:")
    fmt.Printf("%s\n", strconv.QuoteToASCII(str))
    fmt.Println("utf-8ç¼–ç :")
    fmt.Printf("%x\n", str) //é»˜è®¤ä»¥utf-8å­˜å‚¨ï¼Œ%xè¾“å‡º16è¿›åˆ¶
    fmt.Println("utf-16ç¼–ç :")
    hPair, lPair := utf16.EncodeRune('ğŸ’€') //æŠŠå¯¹åº”å­—ç¬¦(runeç±»å‹)è½¬æˆutf-16ä»£ç†å¯¹
    fmt.Printf("%x %x\n", hPair, lPair)

}

lhh@laihanhuadeMacBook-Air î‚° ~/gopath/src/test î‚° go run test_unicodekm.go
Unicodeç ç‚¹:
"\U0001f480"
utf-8ç¼–ç :
f09f9280
utf-16ç¼–ç :
d83d dc80
```

## å®é™…é—®é¢˜

### è¾“å‡ºç¼–ç 
æˆ‘ä»¬ä¸ºäº†èƒ½å¤Ÿè¾“å‡ºç¼–ç æˆUnicodeï¼Œæˆ‘ä»¬å†™äº†å¦‚ä¸‹ç¨‹åºï¼š

```
type QuoteString string

func (q QuoteString) MarshalJSON() ([]byte, error) {
    return []byte(strconv.QuoteToASCII(string(q))), nil
}

type Test struct {
    Name QuoteString `json:"name"`
}

func main() {
    out := Test{Name: "ç¼–ç "}
    b, err := json.Marshal(out)
    if err != nil {
        fmt.Println(err)
        return
    }
    fmt.Println(string(b))
}

 lhh@laihanhuadeMacBook-Air î‚° ~/gopath/src/test î‚° go run test_unicodekm.go
{"name":"\u7f16\u7801"}
```
å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬èƒ½å¤ŸæŠŠâ€œç¼–ç â€å­—ç¬¦ä¸²è¾“å‡ºæˆUnicodeç¼–ç ï¼Œæ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚ä¸€èˆ¬æ¥è¯´å¯¹äºåŸºæœ¬å­—ç¬¦æ¥è¯´æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¯¹äºä¸€äº›æ‹“å±•ç‰¹æ®Šå­—ç¬¦å‘¢ï¼Ÿè¿˜æ˜¯æ‹¿emjoyè¡¨æƒ…ğŸ’€ä¸ºä¾‹è¯•ä¸€ä¸‹

```
func main() {
    out := Test{Name: "ğŸ’€"}
    b, err := json.Marshal(out)
    if err != nil {
        fmt.Println(err)
        return
    }
    fmt.Println(string(b))
}

lhh@laihanhuadeMacBook-Air î‚° ~/gopath/src/test î‚° go run test_unicodekm.go
json: error calling MarshalJSON for type main.QuoteString: invalid character 'U' in string escape code
```
é‚£ä¹ˆå°±æŠ¥é”™äº†ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç è¿˜ä¸èƒ½é€‚ç”¨äºæ‰€æœ‰çš„å­—ç¬¦ã€‚å®é™…ä¸Šï¼Œå¯¹äºUnicodeæ‰©å±•å­—ç¬¦(unicode escape)ï¼Œå³ç ç‚¹>U+FFFFçš„å­—ç¬¦ï¼Œä¸Šè¿°json.Marshalæ—¶å€™å°±ä¼šæŠ¥é”™ã€‚åœ¨[è§„èŒƒä¸­](https://tools.ietf.org/html/rfc7159#section-7)è¯´æ˜ï¼Œå¯¹äºunicode escapeå­—ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šé¢è¯´çš„surrogate pairæ¥è¡¨ç¤ºã€‚ä¿®æ”¹ä¸€ä¸‹MarshalJSON()ä»£ç ï¼š

```
func (q QuoteString) MarshalJSON() ([]byte, error) {
    var result = []byte("\"")
    for _, r := range []rune(q) {
        if r < 0x10000 {
            v := "\\u" + strconv.FormatInt(int64(r), 16)
            result = append(result, []byte(v)...)
            continue
        }
        r1, r2 := utf16.EncodeRune(r)
        v1 := "\\u" + strconv.FormatInt(int64(r1), 16)
        v2 := "\\u" + strconv.FormatInt(int64(r2), 16)
        result = append(append(result, []byte(v1)...), []byte(v2)...)
    }

    result = append(result, []byte("\"")...)
    return result, nil

}

lhh@laihanhuadeMacBook-Air î‚° ~/gopath/src/test î‚° go run test_unicodekm.go
{"name":"\ud83d\udc80"}
```
å¯ä»¥çœ‹åˆ°ï¼Œèƒ½å¤Ÿæ­£å¸¸è¾“å‡ºğŸ’€çš„ä»£ç†å¯¹surrogate pairã€‚è¿™ä¸ªä»£ç†å¯¹ä¹Ÿèƒ½å¤Ÿè¢«æ­£å¸¸çš„è¯†åˆ«åˆ°ä¸ºğŸ’€å­—ç¬¦ã€‚å°ä¼™ä¼´å¯ä»¥ä½¿ç”¨\ud83d\udc80åœ¨æµè§ˆå™¨ä¸Šunicodeè½¬ç æµ‹è¯•ä¸‹ã€‚

### stringå¾ªç¯å¤„ç†
ä»åˆšåˆšä»£ç ä¸­æˆ‘ä»¬å¯ä»¥å»¶ä¼¸å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¹³æ—¶æˆ‘ä»¬å¯¹äºå­—ç¬¦ä¸²å¾ªç¯å¤„ç†æ—¶ï¼Œå¦‚æœé‡åˆ°æœ‰ä¸­æ–‡æ˜¯æ€ä¹ˆæ ·çš„æƒ…å†µå‘¢ï¼Ÿæ‹¿â€œi æ˜¯ emojiğŸ’€â€æ¥æµ‹è¯•ä¸€ä¸‹ã€‚

ä¸€èˆ¬æˆ‘ä»¬å¾ªç¯æœ‰len(str)å’Œrangeä¸¤ç§ï¼Œæˆ‘ä»¬æ¥å¯¹æ¯”ä¸‹è¿™ä¸¤ç§åŒºåˆ«

```
func main() {
    s := "i æ˜¯ emojiğŸ’€"
    for i := 0; i < len(s); i++ {
        fmt.Printf("% x", s[i])
    }
    fmt.Println()
    for _, v := range s {
        fmt.Printf("% x", v)
    }
    fmt.Println()
}

 lhh@laihanhuadeMacBook-Air î‚° ~/gopath/src/test î‚° go run test_unicodekm.go
 69 20 e6 98 af 20 65 6d 6f 6a 69 f0 9f 92 80
 69 20 662f 20 65 6d 6f 6a 69 1f480
```
åœ¨for len(s)ä¸­ï¼Œéå†çš„æ¬¡æ•°æ˜æ˜¾æ¯”range så¤šã€‚è¿™æ˜¯å› ä¸ºå¯¹äºlen(s)çš„æƒ…å†µæ˜¯éå†å­—ç¬¦ä¸²ä¸­çš„å­—èŠ‚ï¼ˆä½¿ç”¨ä¸‹æ ‡è®¿é—®ï¼‰ï¼Œç„¶årange såˆ™æ˜¯éå†å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼ˆfmt.("%x")å¦‚æœæ¥å—çš„å¯¹è±¡æ˜¯å­—ç¬¦ï¼Œå³runeç±»å‹ï¼Œæ­¤æ—¶è¾“å‡ºçš„æ˜¯åå…­è¿›åˆ¶Unicodeç ç‚¹ï¼‰ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸‹å…·ä½“çš„è¾“å‡ºï¼Œâ€œæ˜¯â€åœ¨UTF-8ä¸­å­˜å‚¨ä¸‰ä¸ªå­—èŠ‚ï¼Œå³e6 98 afï¼›è€ŒğŸ’€å­˜å‚¨4ä¸ªå­—èŠ‚ï¼Œå³â€œf0 9f 92 80â€ï¼Œè¿™æ ·å°±å¯¹å¾—ä¸Šäº†ã€‚

## æ€»ç»“

ç”±äºç« é±¼å“¥ç³»ç»Ÿå¤„ç†çš„å­—ç¬¦æƒ…å†µæ¯”è¾ƒå¤šï¼Œä¹Ÿé‡åˆ°äº†ä¸å°‘çš„ç¼–ç é—®é¢˜ã€‚ç‰¹åˆ«æ˜¯å¯¹äºä¸­æ–‡ã€ç‰¹æ®Šå­—ç¬¦çš„æƒ…å†µï¼Œæˆ‘ä»¬è¦ç‰¢è®°golangä¸­çš„ç¼–ç éƒ½æ˜¯UTF-8ï¼Œä»è€Œæ¥è§£å†³è‡ªå·±çš„é—®é¢˜ã€‚å¦‚æœä¸Šé¢æœ‰è¯´å¾—ä¸å¯¹ï¼Œæˆ–è€…æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæ¬¢è¿è®¨è®ºã€‚

## å‚è€ƒ
https://tools.ietf.org/html/rfc7159#section-7
https://apps.timwhitlock.info/unicode/inspect/hex/1F480#block-U1F300
https://cloud.tencent.com/developer/article/1341908
https://github.com/golang/go/issues/39137
https://zh.wikipedia.org/wiki/UTF-16
https://studygolang.com/articles/439
